<div class="stage5-container">
  <!-- Header -->
  <div class="stage-header">
    <h1>
      <mat-icon>brightness_5</mat-icon>
      Schatten markieren
    </h1>
    <p class="subtitle">
      @if (currentScreenshot) {
        Screenshot {{ currentIndex + 1 }}/{{ screenshots.length }}
        <mat-chip class="timestamp-chip">{{ currentScreenshot.timestamp }}</mat-chip>
      }
    </p>
  </div>

  <div class="main-content">
    <!-- LEFT PANEL: Controls -->
    <div class="controls-panel">
      <!-- Screenshot Navigation -->
      <mat-card class="nav-card">
        <mat-card-header>
          <mat-card-title>Screenshots</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="screenshot-list">
            @for (screenshot of screenshots; track screenshot.id; let i = $index) {
              <div
                class="screenshot-item"
                [class.active]="i === currentIndex"
                (click)="goToScreenshot(i)"
              >
                <span class="index">{{ i + 1 }}</span>
                <span class="timestamp">{{ screenshot.timestamp }}</span>
                <span class="object-count">{{ getCompleteObjectsCount(screenshot) }} Obj.</span>
              </div>
            }
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Objects Panel -->
      <mat-expansion-panel expanded>
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon>category</mat-icon>
            Objekte ({{ currentScreenshot?.objects?.length || 0 }})
          </mat-panel-title>
        </mat-expansion-panel-header>

        <button mat-stroked-button color="primary" (click)="onAddObject()" class="add-object-btn">
          <mat-icon>add</mat-icon>
          Neues Objekt
        </button>

        @if (currentScreenshot && currentScreenshot.objects.length > 0) {
          <mat-list class="object-list">
            @for (obj of currentScreenshot.objects; track obj.id; let objIdx = $index) {
              <mat-list-item
                [class.active]="objIdx === currentObjectIndex"
                (click)="onSelectObject(objIdx)"
              >
                <mat-icon matListItemIcon>
                  {{ obj.pairs.length === 3 ? 'check_circle' : 'radio_button_unchecked' }}
                </mat-icon>
                <div matListItemTitle>{{ obj.name }}</div>
                <div matListItemLine>{{ obj.pairs.length }}/3 Punkte</div>
                <button
                  mat-icon-button
                  matListItemMeta
                  color="warn"
                  (click)="onDeleteObject(objIdx); $event.stopPropagation()"
                  matTooltip="Objekt löschen"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </mat-list-item>
            }
          </mat-list>
        } @else {
          <p class="empty-hint">Noch keine Objekte. Klicke "Neues Objekt" um zu beginnen.</p>
        }
      </mat-expansion-panel>

      <!-- Current Object Details -->
      @if (currentObject) {
        <mat-expansion-panel expanded>
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>edit</mat-icon>
              {{ currentObject.name }}
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="marking-instructions">
            @if (waitingForShadowPoint) {
              <div class="instruction shadow">
                <mat-icon>brightness_5</mat-icon>
                <span>Klicke auf den <strong>Schatten-Punkt</strong></span>
              </div>
            } @else if (currentObject.pairs.length < 3) {
              <div class="instruction object">
                <mat-icon>place</mat-icon>
                <span>Klicke auf den <strong>Objekt-Punkt</strong> ({{ currentPairProgress }})</span>
              </div>
            } @else {
              <div class="instruction complete">
                <mat-icon>check_circle</mat-icon>
                <span>Objekt komplett!</span>
              </div>
            }
          </div>

          <!-- Point Pairs List -->
          @if (currentObject.pairs.length > 0) {
            <div class="pairs-list">
              @for (pair of currentObject.pairs; track $index; let pIdx = $index) {
                <div class="pair-item">
                  <span class="pair-index">{{ pIdx + 1 }}</span>
                  <span class="pair-info">
                    Objekt → {{ pair.shadowPoint.wall }}
                  </span>
                  <button
                    mat-icon-button
                    color="warn"
                    (click)="onDeletePair(currentObjectIndex, pIdx)"
                    matTooltip="Paar löschen"
                  >
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              }
            </div>
          }
        </mat-expansion-panel>
      }

      <!-- Display Options -->
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon>visibility</mat-icon>
            Anzeige-Optionen
          </mat-panel-title>
        </mat-expansion-panel-header>

        <mat-slide-toggle [(ngModel)]="showRoomWireframe" (change)="onToggleWireframe()">
          Raum-Wireframe anzeigen
        </mat-slide-toggle>

        <mat-slide-toggle [(ngModel)]="showWallLabels" (change)="drawMarkings()">
          Wand-Labels anzeigen
        </mat-slide-toggle>
      </mat-expansion-panel>

      <!-- Actions -->
      <div class="action-buttons">
        <button mat-button (click)="onBack()">
          <mat-icon>arrow_back</mat-icon>
          Zurück zur Kalibrierung
        </button>

        <button
          mat-raised-button
          color="accent"
          (click)="onSaveShadows()"
          [disabled]="!hasAnyShadows"
        >
          <mat-icon>save</mat-icon>
          Speichern
        </button>

        <button
          mat-raised-button
          color="primary"
          (click)="onProceedToSummary()"
          [disabled]="!hasAnyShadows"
        >
          <mat-icon>arrow_forward</mat-icon>
          Zur Zusammenfassung
        </button>
      </div>
    </div>

    <!-- RIGHT PANEL: Viewer with Overlay -->
    <div class="viewer-panel">
      <div class="viewer-wrapper">
        <app-three-viewer
          #viewer
          [showGrid]="showRoomWireframe"
        ></app-three-viewer>

        <canvas
          #overlayCanvas
          class="overlay-canvas"
          (click)="onOverlayClick($event)"
          (window:resize)="updateOverlayCanvas()"
        ></canvas>
      </div>

      <!-- Legend -->
      <div class="legend">
        <div class="legend-item">
          <span class="dot object"></span>
          Objekt-Punkt
        </div>
        <div class="legend-item">
          <span class="dot shadow"></span>
          Schatten-Punkt
        </div>
        <div class="legend-item">
          <span class="line"></span>
          Verbindung
        </div>
      </div>
    </div>
  </div>
</div>
