<div class="stage-container">
  <mat-card>
    <mat-card-actions align="end">
      <button mat-button (click)="onBack()">
        <mat-icon>arrow_back</mat-icon>
        Zurück
      </button>

      <button
        *ngFor="let s of screenshots; let i = index"
        mat-stroked-button
        [color]="i === currentIndex ? 'primary' : ''"
        [class.complete]="getCompleteObjectsCount(s) >= 2"
        (click)="goToScreenshot(i)"
      >
        <mat-icon *ngIf="getCompleteObjectsCount(s) >= 2">check_circle</mat-icon>
        <mat-icon *ngIf="getCompleteObjectsCount(s) < 2">radio_button_unchecked</mat-icon>
        {{ i + 1 }}
      </button>

      <div class="spacer"></div>

      <button
        mat-raised-button
        color="accent"
        [disabled]="!hasAnyShadows"
        (click)="onSaveShadows()"
      >
        <mat-icon>save</mat-icon>
        Speichern
      </button>

      <button mat-raised-button color="primary" [disabled]="!canProceed" (click)="onFinish()">
        <mat-icon>done_all</mat-icon>
        Abschließen
      </button>
    </mat-card-actions>

    <mat-card-content>
      <!-- Main Layout: Sidebar + Viewer -->
      <div class="main-layout">
        <!-- LEFT SIDEBAR: Objekt-Liste -->
        <div class="sidebar">
          <div class="sidebar-header">
            <h3>Objekte</h3>
            <button
              mat-mini-fab
              color="primary"
              (click)="onAddObject()"
              matTooltip="Objekt hinzufügen"
            >
              <mat-icon>add</mat-icon>
            </button>
          </div>

          <div class="objects-list" *ngIf="currentScreenshot">
            <mat-expansion-panel
              *ngFor="let obj of currentScreenshot.objects; let i = index"
              [expanded]="i === currentObjectIndex"
              (opened)="onSelectObject(i)"
              [class.complete]="obj.pairs.length === 3"
            >
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <mat-icon *ngIf="obj.pairs.length === 3" class="status-icon complete"
                    >check_circle</mat-icon
                  >
                  <mat-icon *ngIf="(obj.pairs.length || 0) < 3" class="status-icon incomplete"
                    >radio_button_unchecked</mat-icon
                  >
                  {{ obj.name }}
                </mat-panel-title>
                <mat-panel-description>
                  {{ obj.pairs.length || 0 }} / 3 Punkte
                </mat-panel-description>
              </mat-expansion-panel-header>

              <!-- Punkt-Paare -->
              <div class="pairs-list">
                <div *ngFor="let pair of obj.pairs; let pairIdx = index" class="pair-item">
                  <div class="pair-info">
                    <mat-icon class="pair-icon">wb_sunny</mat-icon>
                    <div class="pair-details">
                      <div class="pair-title">Punkt {{ pairIdx + 1 }}</div>
                      <div class="pair-data">
                        Objekt: ({{ pair.objectPoint.normalizedX | number : '1.3-3' }},
                        {{ pair.objectPoint.normalizedY | number : '1.3-3' }})
                      </div>
                      <div class="pair-data">
                        Schatten: ({{ pair.shadowPoint.normalizedX | number : '1.3-3' }},
                        {{ pair.shadowPoint.normalizedY | number : '1.3-3' }}) →
                        <strong>{{ pair.shadowPoint.wall }}</strong>
                      </div>
                    </div>
                  </div>
                  <button
                    mat-icon-button
                    color="warn"
                    (click)="onDeletePair(i, pairIdx)"
                    matTooltip="Punkt löschen"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>

                <div *ngIf="!obj.pairs || obj.pairs.length === 0" class="empty-hint">
                  Noch keine Punkte markiert
                </div>
              </div>

              <!-- Actions -->
              <mat-action-row>
                <button mat-button color="warn" (click)="onDeleteObject(i)">
                  <mat-icon>delete</mat-icon>
                  Objekt löschen
                </button>
              </mat-action-row>
            </mat-expansion-panel>

            <div
              *ngIf="!currentScreenshot.objects || currentScreenshot.objects.length === 0"
              class="empty-hint"
            >
              Noch keine Objekte hinzugefügt
            </div>
          </div>
        </div>

        <!-- CENTER: Three.js Viewer + Overlay Canvas -->
        <div class="viewer-column">
          <!-- Viewer Container mit Overlay -->
          <div class="viewer-container">
            <!-- Three.js Viewer (read-only, mit FOV!) -->
            <app-three-viewer
              #viewer
              [roomParams]="currentRoomParams"
              [fovY]="globalFovY"
              [showGrid]="showRoomWireframe"
            ></app-three-viewer>

            <!-- Overlay Canvas für Markierungen -->
            <canvas #overlayCanvas class="overlay-canvas" (click)="onOverlayClick($event)"></canvas>

            <!-- Instructions -->
            <div class="instructions" *ngIf="currentObjectIndex >= 0 && !waitingForShadowPoint">
              <mat-icon>touch_app</mat-icon>
              <span>Klicke auf Objekt-Punkt ({{ currentPairProgress }})</span>
            </div>

            <div class="instructions warning" *ngIf="waitingForShadowPoint">
              <mat-icon>touch_app</mat-icon>
              <span>Klicke auf Schatten-Ende ({{ currentPairProgress }}) auf Wand!</span>
            </div>

            <div class="instructions error" *ngIf="currentObjectIndex < 0">
              <mat-icon>info</mat-icon>
              <span>Bitte erst Objekt hinzufügen!</span>
            </div>
          </div>

          <!-- Wall Legend -->
          <div class="wall-legend">
            <div class="legend-title">Wände:</div>
            <div class="legend-items">
              <div class="legend-item">
                <div class="color-box back"></div>
                <span>Rückwand (back)</span>
              </div>
              <div class="legend-item">
                <div class="color-box left"></div>
                <span>Links (left)</span>
              </div>
              <div class="legend-item">
                <div class="color-box right"></div>
                <span>Rechts (right)</span>
              </div>
              <div class="legend-item">
                <div class="color-box floor"></div>
                <span>Boden (floor)</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
