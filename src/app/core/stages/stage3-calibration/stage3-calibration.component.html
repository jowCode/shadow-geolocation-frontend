<div class="stage-container">
  <mat-card>
    <mat-card-actions align="end">
      <button mat-button (click)="onBack()">
        <mat-icon>arrow_back</mat-icon>
        Back
      </button>

      <button
        *ngFor="let step of calibrationSteps; let i = index"
        mat-stroked-button
        [color]="i === currentStepIndex ? 'primary' : ''"
        [class.completed]="step.completed"
        (click)="goToScreenshot(i)"
      >
        <mat-icon *ngIf="step.completed">check_circle</mat-icon>
        <mat-icon *ngIf="!step.completed">radio_button_unchecked</mat-icon>
        {{ i + 1 }}
      </button>

      <div class="spacer"></div>

      <button mat-raised-button color="accent" (click)="onSaveCurrentScreenshot()">
        <mat-icon>save</mat-icon>
        Save
      </button>

      <button
        mat-raised-button
        color="primary"
        [disabled]="completedCount < 2"
        (click)="onProceedToShadows()"
      >
        <mat-icon>wb_sunny</mat-icon>
        ----/ Marking shadows
      </button>
    </mat-card-actions>

    <mat-card-content>
      <!-- DREI-SPALTEN-LAYOUT -->
      <div class="three-column-layout">
        <!-- LINKE SPALTE: Globale Parameter + Screenshot-Anpassungen -->
        <div class="left-column">
          <!-- NEU: Globale Kamera-Optik -->
          <div class="control-group global-params">
            <div class="control-header">
              <h3>
                <mat-icon>camera</mat-icon>
                Field of view
              </h3>
              <span class="badge global">GLOBAL</span>
            </div>

            <!-- Field of View -->
            <div class="slider-row">
              <label matTooltip="Field of view">FOV:</label>
              <mat-slider min="30" max="120" step="1">
                <input matSliderThumb [(ngModel)]="globalFovY" (ngModelChange)="onFovChange()" />
              </mat-slider>
              <span class="value">{{ globalFovY }}°</span>
            </div>

            <!-- Info-Hinweis -->
            <div class="info-hint">
              <mat-icon>info</mat-icon>
              <span>50-70° (Normal angle), 90-120° (Wide angle)</span>
            </div>
          </div>

          <!-- Kamera-Position (global) -->
          <div class="control-group global-params">
            <div class="control-header">
              <h3>
                <mat-icon>videocam</mat-icon>
                Camera-position
              </h3>
              <span class="badge global">GLOBAL</span>
            </div>

            <div class="slider-row">
              <label>X:</label>
              <mat-slider min="0" [max]="currentRoomParams.width" step="0.1">
                <input
                  matSliderThumb
                  [(ngModel)]="globalCameraPosition.x"
                  (ngModelChange)="onGlobalCameraPositionChange()"
                />
              </mat-slider>
              <span class="value">{{ globalCameraPosition.x.toFixed(1) }}m</span>
            </div>

            <div class="slider-row">
              <label>Y:</label>
              <mat-slider min="0" [max]="currentRoomParams.height" step="0.1">
                <input
                  matSliderThumb
                  [(ngModel)]="globalCameraPosition.y"
                  (ngModelChange)="onGlobalCameraPositionChange()"
                />
              </mat-slider>
              <span class="value">{{ globalCameraPosition.y.toFixed(1) }}m</span>
            </div>

            <div class="slider-row">
              <label>Z:</label>
              <mat-slider min="0" [max]="currentRoomParams.depth" step="0.1">
                <input
                  matSliderThumb
                  [(ngModel)]="globalCameraPosition.z"
                  (ngModelChange)="onGlobalCameraPositionChange()"
                />
              </mat-slider>
              <span class="value">{{ globalCameraPosition.z.toFixed(1) }}m</span>
            </div>
          </div>

          <!-- Raum-Dimensionen -->
          <div class="control-group global-params">
            <div class="control-header">
              <h3>
                <mat-icon>straighten</mat-icon>
                Room-Dimension
              </h3>
              <span class="badge global">GLOBAL</span>
            </div>
            <div class="slider-row">
              <label>B:</label>
              <mat-slider min="2" max="15" step="0.1">
                <input
                  matSliderThumb
                  [(ngModel)]="currentRoomParams.width"
                  (ngModelChange)="onRoomChange()"
                />
              </mat-slider>
              <span class="value">{{ currentRoomParams.width.toFixed(1) }}m</span>
            </div>

            <div class="slider-row">
              <label>T:</label>
              <mat-slider min="2" max="15" step="0.1">
                <input
                  matSliderThumb
                  [(ngModel)]="currentRoomParams.depth"
                  (ngModelChange)="onRoomChange()"
                />
              </mat-slider>
              <span class="value">{{ currentRoomParams.depth.toFixed(1) }}m</span>
            </div>

            <div class="slider-row">
              <label>H:</label>
              <mat-slider min="2" max="5" step="0.1">
                <input
                  matSliderThumb
                  [(ngModel)]="currentRoomParams.height"
                  (ngModelChange)="onRoomChange()"
                />
              </mat-slider>
              <span class="value">{{ currentRoomParams.height.toFixed(1) }}m</span>
            </div>
          </div>
        </div>

        <!-- MITTLERE SPALTE: 3D Viewer -->
        <div class="viewer-column">
          <app-three-viewer
            #viewer
            [backgroundImage]="currentStep?.screenshot?.file ?? undefined"
            [roomParams]="currentRoomParams"
            [roomRotation]="{
              x: currentCameraRotation.x,
              y: currentCameraRotation.y,
              z: currentCameraRotation.z
            }"
            [cameraPosition]="globalCameraPosition"
            [fovY]="globalFovY"
            [backgroundRotation]="currentDisplay.backgroundRotation"
            [backgroundScale]="currentDisplay.backgroundScale"
            [backgroundOffsetX]="currentDisplay.backgroundOffsetX"
            [backgroundOffsetY]="currentDisplay.backgroundOffsetY"
            [showGrid]="showGrid"
            (rotationChange)="onViewerRotationChange($event)"
          >
          </app-three-viewer>

          <!-- NEU: Hinweis für Maus-Steuerung -->
          <div class="viewer-hint">
            <mat-icon>mouse</mat-icon>
            <span>Drag to change view direction</span>
          </div>
        </div>

        <!-- RECHTE SPALTE: Kamera-Position & Rotation -->
        <div class="right-column">
          <!-- Kamera-Blickrichtung (pro Screenshot) -->
          <div class="control-group">
            <div class="control-header">
              <h3>
                <mat-icon>pan_tool</mat-icon>
                View direction
              </h3>
              <!-- NEU: Rotation-Anzeige -->
              <span class="rotation-display">
                {{ currentCameraRotation.x.toFixed(0) }}° /
                {{ currentCameraRotation.y.toFixed(0) }}°
              </span>
            </div>

            <div class="slider-row">
              <label matTooltip="Pitch">V:</label>
              <mat-slider min="-90" max="90" step="1">
                <input
                  matSliderThumb
                  [(ngModel)]="currentCameraRotation.x"
                  (ngModelChange)="onCameraRotationChange()"
                />
              </mat-slider>
              <span class="value">{{ currentCameraRotation.x }}°</span>
            </div>

            <div class="slider-row">
              <label matTooltip="Yaw">H:</label>
              <mat-slider min="-180" max="180" step="1">
                <input
                  matSliderThumb
                  [(ngModel)]="currentCameraRotation.y"
                  (ngModelChange)="onCameraRotationChange()"
                />
              </mat-slider>
              <span class="value">{{ currentCameraRotation.y }}°</span>
            </div>

            <!-- NEU: Hinweis auf Maus-Drag -->
            <div class="info-hint muted">
              <mat-icon>lightbulb</mat-icon>
              <span>Or drag in viewer with mouse</span>
            </div>
          </div>

          <!-- Display-Zoom (UI-Parameter) -->
          <div class="control-group global-params">
            <div class="control-header">
              <h3>
                <mat-icon>zoom_in</mat-icon>
                Image size
              </h3>
              <span class="badge global">GLOBAL</span>
            </div>

            <div class="slider-row">
              <label matTooltip="Image size">Zoom:</label>
              <mat-slider min="10" max="200" step="1">
                <input
                  matSliderThumb
                  [(ngModel)]="globalDisplayZoom"
                  (ngModelChange)="onDisplayZoomChange()"
                />
              </mat-slider>
              <span class="value">{{ globalDisplayZoom }}%</span>
            </div>
          </div>

          <!-- Screenshot-spezifische Anpassungen -->
          <div class="control-group">
            <div class="control-header">
              <h3>
                <mat-icon>image</mat-icon>
                Screenshot-Ausrichtung
              </h3>
            </div>
            <div class="slider-row">
              <mat-icon class="slider-icon" matTooltip="Rotation">rotate_right</mat-icon>
              <mat-slider min="0" max="360" step="1">
                <input
                  matSliderThumb
                  [(ngModel)]="currentDisplay.backgroundRotation"
                  (ngModelChange)="onBackgroundRotationChange()"
                />
              </mat-slider>
              <span class="value">{{ currentDisplay.backgroundRotation }}°</span>
            </div>

            <div class="slider-row">
              <mat-icon class="slider-icon" matTooltip="Horizontal">swap_horiz</mat-icon>
              <mat-slider min="0" max="100" step="1">
                <input
                  matSliderThumb
                  [(ngModel)]="currentDisplay.backgroundOffsetX"
                  (ngModelChange)="onBackgroundOffsetChange()"
                />
              </mat-slider>
              <span class="value">{{ currentDisplay.backgroundOffsetX }}%</span>
            </div>

            <div class="slider-row">
              <mat-icon class="slider-icon" matTooltip="Vertikal">swap_vert</mat-icon>
              <mat-slider min="0" max="100" step="1">
                <input
                  matSliderThumb
                  [(ngModel)]="currentDisplay.backgroundOffsetY"
                  (ngModelChange)="onBackgroundOffsetChange()"
                />
              </mat-slider>
              <span class="value">{{ currentDisplay.backgroundOffsetY }}%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- PROGRESS BAR -->
      <div class="calibration-progress">
        <div class="progress-header">
          <h3>Fortschritt</h3>
          <span class="progress-text">{{ completedCount }} / {{ calibrationSteps.length }}</span>
        </div>
        <mat-progress-bar
          mode="determinate"
          [value]="progressPercentage"
          [color]="progressPercentage === 100 ? 'primary' : 'accent'"
        >
        </mat-progress-bar>

        <!-- OPTIMIERUNGS-EINSTELLUNGEN -->
        <mat-expansion-panel class="optimization-panel">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>tune</mat-icon>
              Optimierungs-Einstellungen
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="optimization-content">
            <div class="confidence-sliders">
              <div class="slider-row">
                <label>Raum-Dimensionen:</label>
                <span class="confidence-label left">unsicher</span>
                <mat-slider min="0" max="1" step="0.1" class="confidence-slider">
                  <input matSliderThumb [(ngModel)]="roomConfidence" />
                </mat-slider>
                <span class="confidence-label right">sicher</span>
                <span class="value">{{ roomConfidence }}</span>
              </div>

              <div class="slider-row">
                <label>Kamera-Position:</label>
                <span class="confidence-label left">unsicher</span>
                <mat-slider min="0" max="1" step="0.1" class="confidence-slider">
                  <input matSliderThumb [(ngModel)]="positionConfidence" />
                </mat-slider>
                <span class="confidence-label right">sicher</span>
                <span class="value">{{ positionConfidence }}</span>
              </div>
            </div>
            <button
              mat-raised-button
              color="primary"
              [disabled]="completedCount < 2 || isOptimizing"
              (click)="onStartOptimization()"
            >
              <mat-icon>auto_fix_high</mat-icon>
              Optimierung starten
            </button>
          </div>
        </mat-expansion-panel>
      </div>
    </mat-card-content>
  </mat-card>
</div>
