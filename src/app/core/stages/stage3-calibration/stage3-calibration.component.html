<div class="stage-container">
  <mat-card>
    <mat-card-header>
      <mat-card-subtitle>
        Screenshot {{ currentStepIndex + 1 }} / {{ calibrationSteps.length }} ·
        {{ completedCount }} kalibriert
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <!-- SCREENSHOT-NAVIGATION -->
      <div class="screenshot-navigation">
        <button
          *ngFor="let step of calibrationSteps; let i = index"
          mat-stroked-button
          [color]="i === currentStepIndex ? 'primary' : ''"
          [class.active]="i === currentStepIndex"
          [class.completed]="step.completed"
          (click)="goToScreenshot(i)"
        >
          <mat-icon *ngIf="step.completed">check_circle</mat-icon>
          <mat-icon *ngIf="!step.completed">radio_button_unchecked</mat-icon>
          {{ i + 1 }}
        </button>
      </div>

      <!-- DREI-SPALTEN-LAYOUT -->
      <div class="three-column-layout">
        <!-- LINKE SPALTE: Screenshot-Anpassungen -->
        <div class="left-column">
          <!-- Screenshot-Rotation -->
          <div class="control-group">
            <h3>Screenshot Rotation</h3>
            <div class="slider-row">
              <mat-icon class="slider-icon" matTooltip="Rotation">rotate_right</mat-icon>
              <mat-slider min="0" max="360" step="1">
                <input
                  matSliderThumb
                  [(ngModel)]="currentBackgroundRotation"
                  (ngModelChange)="onBackgroundRotationChange()"
                />
              </mat-slider>
              <span class="value">{{ currentBackgroundRotation }}°</span>
            </div>
          </div>

          <!-- Screenshot-Position -->
          <div class="control-group">
            <h3>Screenshot Position</h3>

            <div class="slider-row">
              <mat-icon class="slider-icon" matTooltip="Horizontal">swap_horiz</mat-icon>
              <mat-slider min="0" max="100" step="1">
                <input
                  matSliderThumb
                  [(ngModel)]="currentBackgroundOffsetX"
                  (ngModelChange)="onBackgroundOffsetChange()"
                />
              </mat-slider>
              <span class="value">{{ currentBackgroundOffsetX }}%</span>
            </div>

            <div class="slider-row">
              <mat-icon class="slider-icon" matTooltip="Vertikal">swap_vert</mat-icon>
              <mat-slider min="0" max="100" step="1">
                <input
                  matSliderThumb
                  [(ngModel)]="currentBackgroundOffsetY"
                  (ngModelChange)="onBackgroundOffsetChange()"
                />
              </mat-slider>
              <span class="value">{{ currentBackgroundOffsetY }}%</span>
            </div>
          </div>

          <!-- Anzeige-Optionen -->
          <div class="control-group">
            <h3>Anzeige</h3>
            <mat-checkbox [(ngModel)]="showGrid" (ngModelChange)="onToggleGrid()">
              Boden-Grid
            </mat-checkbox>

            <div class="info-message-compact" style="margin-top: 6px">
              <mat-icon>mouse</mat-icon>
              <span>Mausrad = Zoom (nicht gespeichert)</span>
            </div>
          </div>
        </div>

        <!-- MITTLERE SPALTE: 3D Viewer -->
        <div class="viewer-column">
          <app-three-viewer
            #viewer
            [backgroundImage]="currentStep?.screenshot?.file ?? undefined"
            [roomParams]="currentRoomParams"
            [roomRotation]="currentRoomRotation"
            [cameraPosition]="currentCameraPosition"
            [backgroundRotation]="currentBackgroundRotation"
            [backgroundScale]="currentBackgroundScale"
            [backgroundOffsetX]="currentBackgroundOffsetX"
            [backgroundOffsetY]="currentBackgroundOffsetY"
            [showGrid]="showGrid"
          >
          </app-three-viewer>
        </div>

        <!-- RECHTE SPALTE: Kamera-Einstellungen -->
        <div class="right-column">
          <!-- Kamera-Position -->
          <div class="control-group">
            <div class="control-header">
              <h3>Kamera Position</h3>
              <mat-checkbox
                [(ngModel)]="lockCameraPosition"
                matTooltip="Für alle Screenshots fixieren"
              >
                Fix
              </mat-checkbox>
            </div>

            <div class="slider-row">
              <label>X:</label>
              <mat-slider
                min="0"
                [max]="currentRoomParams.width"
                step="0.1"
                [disabled]="lockCameraPosition && completedCount > 0"
              >
                <input
                  matSliderThumb
                  [(ngModel)]="currentCameraPosition.x"
                  (ngModelChange)="onCameraPositionChange()"
                />
              </mat-slider>
              <span class="value">{{ currentCameraPosition.x.toFixed(1) }}m</span>
            </div>

            <div class="slider-row">
              <label>Y:</label>
              <mat-slider
                min="0"
                [max]="currentRoomParams.height"
                step="0.1"
                [disabled]="lockCameraPosition && completedCount > 0"
              >
                <input
                  matSliderThumb
                  [(ngModel)]="currentCameraPosition.y"
                  (ngModelChange)="onCameraPositionChange()"
                />
              </mat-slider>
              <span class="value">{{ currentCameraPosition.y.toFixed(1) }}m</span>
            </div>

            <div class="slider-row">
              <label>Z:</label>
              <mat-slider
                min="0"
                [max]="currentRoomParams.depth"
                step="0.1"
                [disabled]="lockCameraPosition && completedCount > 0"
              >
                <input
                  matSliderThumb
                  [(ngModel)]="currentCameraPosition.z"
                  (ngModelChange)="onCameraPositionChange()"
                />
              </mat-slider>
              <span class="value">{{ currentCameraPosition.z.toFixed(1) }}m</span>
            </div>

            <div
              *ngIf="lockCameraPosition && completedCount > 0"
              class="info-message-compact"
              style="background: #e3f2fd"
            >
              <mat-icon>lock</mat-icon>
              <span>Fixiert für alle</span>
            </div>
          </div>

          <!-- Kamera-Rotation -->
          <div class="control-group">
            <h3>Kamera Rotation</h3>

            <div class="slider-row">
              <label>X:</label>
              <mat-slider min="-180" max="180" step="1">
                <input
                  matSliderThumb
                  [(ngModel)]="currentRoomRotation.x"
                  (ngModelChange)="onRoomRotationChange()"
                />
              </mat-slider>
              <span class="value">{{ currentRoomRotation.x }}°</span>
            </div>

            <div class="slider-row">
              <label>Y:</label>
              <mat-slider min="-180" max="180" step="1">
                <input
                  matSliderThumb
                  [(ngModel)]="currentRoomRotation.y"
                  (ngModelChange)="onRoomRotationChange()"
                />
              </mat-slider>
              <span class="value">{{ currentRoomRotation.y }}°</span>
            </div>
          </div>
        </div>
      </div>

      <!-- RAUM-DIMENSIONEN (GLOBAL) - HORIZONTAL BAR -->
      <div class="room-dimensions-bar">
        <h3>Globale Parameter</h3>
        <div class="room-slider-group">
          <div class="room-slider-item">
            <label>B:</label>
            <mat-slider min="2" max="15" step="0.1">
              <input
                matSliderThumb
                [(ngModel)]="currentRoomParams.width"
                (ngModelChange)="onRoomChange()"
              />
            </mat-slider>
            <span class="value">{{ currentRoomParams.width.toFixed(1) }}m</span>
          </div>

          <div class="room-slider-item">
            <label>T:</label>
            <mat-slider min="2" max="15" step="0.1">
              <input
                matSliderThumb
                [(ngModel)]="currentRoomParams.depth"
                (ngModelChange)="onRoomChange()"
              />
            </mat-slider>
            <span class="value">{{ currentRoomParams.depth.toFixed(1) }}m</span>
          </div>

          <div class="room-slider-item">
            <label>H:</label>
            <mat-slider min="2" max="5" step="0.1">
              <input
                matSliderThumb
                [(ngModel)]="currentRoomParams.height"
                (ngModelChange)="onRoomChange()"
              />
            </mat-slider>
            <span class="value">{{ currentRoomParams.height.toFixed(1) }}m</span>
          </div>

          <div class="room-slider-item">
            <label matTooltip="Screenshot-Größe (Focal Length)">S:</label>
            <mat-slider min="10" max="200" step="1">
              <input
                matSliderThumb
                [(ngModel)]="currentBackgroundScale"
                (ngModelChange)="onBackgroundScaleChange()"
              />
            </mat-slider>
            <span class="value">{{ currentBackgroundScale }}%</span>
          </div>
        </div>
      </div>

      <!-- PROGRESS BAR -->
      <div class="calibration-progress">
        <div class="progress-header">
          <h3>Fortschritt</h3>
          <span class="progress-text">{{ completedCount }} / {{ calibrationSteps.length }}</span>
        </div>
        <mat-progress-bar
          mode="determinate"
          [value]="progressPercentage"
          [color]="progressPercentage === 100 ? 'primary' : 'accent'"
        >
        </mat-progress-bar>

        <!-- OPTIMIERUNGS-EINSTELLUNGEN -->
        <mat-expansion-panel class="optimization-panel">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>tune</mat-icon>
              Optimierungs-Einstellungen
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="optimization-content">
            <h4>Wie sicher bist du bei deinen Schätzungen?</h4>
            <p class="hint">
              <mat-icon>info</mat-icon>
              Niedriger Wert = Parameter wird stärker optimiert
            </p>

            <div class="confidence-sliders">
              <div class="slider-row">
                <label>Raum-Dimensionen:</label>
                <span class="confidence-label left">unsicher</span>
                <mat-slider min="0" max="1" step="0.1" class="confidence-slider">
                  <input matSliderThumb [(ngModel)]="roomConfidence" />
                </mat-slider>
                <span class="confidence-label right">sicher</span>
                <span class="value">{{ roomConfidence }}</span>
              </div>

              <div class="slider-row">
                <label>Kamera-Position:</label>
                <span class="confidence-label left">unsicher</span>
                <mat-slider min="0" max="1" step="0.1" class="confidence-slider">
                  <input matSliderThumb [(ngModel)]="positionConfidence" />
                </mat-slider>
                <span class="confidence-label right">sicher</span>
                <span class="value">{{ positionConfidence }}</span>
              </div>
            </div>

            <div class="info-box">
              <mat-icon>lightbulb</mat-icon>
              <p>
                Die Optimierung findet EINE globale Kamera-Position, die für alle Screenshots passt
                (nur mit unterschiedlicher Rotation).
              </p>
            </div>
          </div>
        </mat-expansion-panel>
      </div>
    </mat-card-content>

    <mat-card-actions align="end">
      <button mat-button (click)="onBack()">
        <mat-icon>arrow_back</mat-icon>
        Zurück
      </button>

      <div class="spacer"></div>

      <button mat-raised-button color="accent" (click)="onSaveCurrentScreenshot()">
        <mat-icon>save</mat-icon>
        Speichern
      </button>

      <button
        mat-raised-button
        color="primary"
        [disabled]="completedCount < 2 || isOptimizing"
        (click)="onStartOptimization()"
      >
        <mat-icon>auto_fix_high</mat-icon>
        Optimierung starten
      </button>

      <button
        mat-raised-button
        color="primary"
        [disabled]="completedCount < 2"
        (click)="onProceedToShadows()"
      >
        <mat-icon>wb_sunny</mat-icon>
        Weiter zur Schatten-Markierung
      </button>
    </mat-card-actions>
  </mat-card>
</div>
